name: Propagate Changes Between Branches

on:
  push:
    branches:
      - main
      - development

permissions:
  contents: write
  pull-requests: write

jobs:
  propagate:
    name: Create PR to synchronize branches
    runs-on: ubuntu-latest
    if: github.actor != 'github-actions[bot]' && github.event.pusher != null
    steps:
      - name: Set up Node (for github-script)
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: '18'

      - name: Determine source and target branches
        id: branches
        run: |
          echo "source=$(echo ${GITHUB_REF#refs/heads/})" >> $GITHUB_OUTPUT
          if [ "${GITHUB_REF#refs/heads/}" = "main" ]; then
            echo "target=development" >> $GITHUB_OUTPUT
          else
            echo "target=main" >> $GITHUB_OUTPUT
          fi

      - name: Create or update Pull Request
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
        with:
          script: |
            const source = process.env.SOURCE_BRANCH || process.env.GITHUB_REF.replace('refs/heads/','');
            const target = process.env.TARGET_BRANCH || (source === 'main' ? 'development' : 'main');

            const src = source;
            const base = target;

            // Do not create PR if source and base are same
            if (src === base) {
              core.info(`Source and base are the same (${src}); skipping.`);
              return;
            }

            // Check for existing open PRs from src->base
            const { data: pulls } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:${src}`,
              base: base,
            });

            if (pulls.length > 0) {
              core.info(`Found existing PR(s) from ${src} to ${base}. Skipping creation.`);
              return;
            }

            // Compare commits: only create PR if source is ahead of base
            const compare = await github.rest.repos.compareCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              base: base,
              head: src,
            });

            if (compare.data && compare.data.status === 'identical') {
              core.info(`${src} and ${base} are identical. No PR needed.`);
              return;
            }

            // Create PR
            const title = `Propagate changes from ${src} into ${base}`;
            const body = `Automated PR to propagate commits from ${src} into ${base}.\n\nTriggered by push by @${context.actor}.`;

            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              head: src,
              base,
              body,
            });

            core.info(`Created PR #${pr.data.number}: ${pr.data.html_url}`);
        env:
          GITHUB_TOKEN: ${{ secrets.PROJECT_TOKEN }}
          SOURCE_BRANCH: ${{ steps.branches.outputs.source }}
          TARGET_BRANCH: ${{ steps.branches.outputs.target }}
